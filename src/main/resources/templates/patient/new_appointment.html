<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>Appointment</title>
    <meta th:replace="common/meta" />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <div th:replace="common/errors" />
    <!-- Header with logo, logout and breadcrumbs -->
    <div th:replace="common/header"></div>
    <!-- Content -->
    <div class="et-content">
      <div class="et-card p-5 w-100">
        <h2 class="text-2xl font-semibold text-gray-800 mb-2">
          Appointment Details
        </h2>
        <!-- Form that ridiract to /appointments page -->
        <form action="/patient/new_appointment" method="post">
          <div class="mb-4">
            <!-- Date Field -->
            <label for="date" class="block text-gray-700 text-sm font-bold mb-2"
              >Date and Time:</label
            >
            <input
              required
              type="date"
              name="date"
              id="date"
              class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500"
            />
            <p id="errorMessage" style="color: red; display: none"></p>
          </div>
          <div class="mb-4">
            <!-- Time Dropdown -->
            <label for="time" class="block text-gray-700 text-sm font-bold mb-2"
              >Time:</label
            >
            <select
              required
              name="time"
              id="time"
              class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500"
            >
              <option value="" selected disabled>Select Time</option>
              <option value="08:00">08:00</option>
              <option value="08:30">08:30</option>
              <option value="09:00">09:00</option>
              <option value="09:30">09:30</option>
              <option value="10:00">10:00</option>
              <option value="10:30">10:30</option>
              <option value="11:00">11:00</option>
              <option value="11:30">11:30</option>
              <option value="12:00">12:00</option>
              <option value="12:30">12:30</option>
              <option value="13:00">13:00</option>
              <option value="13:30">14:30</option>
              <option value="14:00">14:00</option>
              <option value="14:30">14:30</option>
              <option value="15:00">15:00</option>
              <option value="15:30">15:30</option>
              <option value="16:00">16:00</option>
              <option value="16:30">16:30</option>
              <option value="17:00">17:00</option>
              <option value="17:30">17:30</option>
              <option value="18:00">18:00</option>
              <option value="18:30">18:30</option>
              <option value="19:00">19:00</option>
              <option value="19:30">19:30</option>
              <option value="20:00">20:00</option>
              <option value="20:30">20:30</option>
              <option value="21:00">21:00</option>
            </select>
          </div>

          <div class="mb-4">
            <!-- Note Field -->
            <label for="note" class="block text-gray-700 text-sm font-bold mb-2"
              >Note:</label
            >
            <textarea
              name="note"
              id="note"
              rows="4"
              class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500"
            ></textarea>
          </div>

          <!-- Visit types -->
          <div class="mb-4">
            <label
              for="visitType"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Visit Type:</label
            >
            <select
              name="visitType"
              id="visitType"
              class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500"
            >
              <option
                th:each="category : ${visitTypes}"
                th:value="${category}"
                th:text="${category}"
              >
                Visit Type
              </option>
            </select>
          </div>
          <!-- Urgency -->
          <div class="mb-4">
            <label
              for="urgency"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Urgency:</label
            >
            <select
              name="urgency"
              id="urgency"
              class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500"
            >
              <option value="1">Low</option>
              <option value="2">Medium</option>
              <option value="3">High</option>
            </select>
          </div>
          <div id="medicoContainer" class="mb-4">
            <label
              for="medico"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Medico:</label
            >
            <select
              name="medico"
              id="medico"
              class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500"
            >
              <option
                th:each="medico : ${medici}"
                th:value="${medico.id}"
                th:text="${medico.fullName()}"
              >
                Medico
              </option>
            </select>
          </div>

          <div id="nurseContainer" style="display: none" class="mb-4">
            <label
              for="nurse"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Nurse:</label
            >
            <select
              name="nurse"
              id="nurse"
              class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500"
            >
              <option
                th:each="nurse : ${nurses}"
                th:value="${nurse.id}"
                th:text="${nurse.fullName()}"
              >
                Medico
              </option>
            </select>
          </div>

          <div class="flex justify-end">
            <button type="submit" class="et-button-secondary w-full h-12">
              Submit
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
      $(document).ready(function () {
        const timeSelect = $("#time");
        const errorMessage = $("#errorMessage");

        function disableTimeOptions() {
          const dateInput = $("#date");
          const selectedDate = new Date(dateInput.val());
          const currentDate = new Date();
          currentDate.setHours(0, 0, 0, 0); // Reset time part of current date to compare only dates

          // Check if the selected date is a weekend
          const isWeekend =
            selectedDate.getDay() === 0 || selectedDate.getDay() === 6;
          // Check if the selected date is in the past
          const isPastDate = selectedDate < currentDate;

          if (!dateInput.val() || isWeekend || isPastDate) {
            let errorText = "Please select a valid date.";
            if (isWeekend) {
              errorText = "Weekends are not allowed.";
            } else if (isPastDate) {
              errorText = "Past dates are not allowed.";
            }
            timeSelect.prop("disabled", true);
            timeSelect.css("color", "transparent");
            errorMessage.text(errorText);
            errorMessage.show();
          } else {
            timeSelect.prop("disabled", false);
            timeSelect.css("color", ""); // Reset color to default
            errorMessage.hide();
          }
        }

        // Disable time options on page load
        disableTimeOptions();

        // Event listener for date input change
        $("#date").change(function () {
          disableTimeOptions();
        });

        let orariMedico = [];
        let orariNurse = [];
        let medicoId = null;
        let nurseId = null;
        let getDate = null;
        let timeMedico = [];
        let timeNurse = [];

        // Get the select element
        const timeSelectMedico = $("#time")[0];
        const timeSelectNurse = $("#time")[0];

        // Function to fetch orari data based on selected medico
        function fetchOrariData(medicoId) {
          $.ajax({
            url: "/patient/orari", // Endpoint to fetch orari data
            type: "GET",
            data: { medicoId: medicoId },
            success: function (data) {
              // Extract the available dates and times for the selected medico
              orariMedico = Object.entries(data)
                .filter(([key, value]) => key.includes(`id=${medicoId}`))
                .map(([key, value]) => value);
              // Ensure functionality is triggered for initial load
              triggerFunctionalityMedico();
            },
            error: function (xhr, status, error) {
              // Handle errors
              console.error(error);
            },
          });
        }

        // Function to trigger functionality on medico or date change
        function triggerFunctionalityMedico() {
          // Empty the time array
          timeMedico = [];

          // Iterate over the orari data
          orariMedico.forEach((entry) => {
            // Iterate over the keys and values of each entry
            Object.entries(entry).forEach(([date, times]) => {
              // select the date and add the times of that date to the time array
              if (date === getDate) {
                timeMedico.push(...times);
              }
            });
          });

          // Show all options
          for (let i = 0; i < timeSelectMedico.options.length; i++) {
            const option = timeSelectMedico.options[i];
            option.style.display = "block";
          }

          // Iterate in each time value
          for (let i = 0; i < timeMedico.length; i++) {
            const timeValue = timeMedico[i];
            // Iterate in each option
            for (let j = 0; j < timeSelectMedico.options.length; j++) {
              const option = timeSelectMedico.options[j];
              // Check all the options with the array times values
              if (option.value === timeValue) {
                option.style.display = "none";
              }
            }
          }
        }

        // Function to fetch orari data based on selected nurse
        function fetchOrariNurseData(nurseId) {
          $.ajax({
            url: "/patient/orari_nurse", // Endpoint to fetch orari data
            type: "GET",
            data: { nurseId: nurseId },
            success: function (data) {
              // Extract the available dates and times for the selected nurse
              orariNurse = Object.entries(data)
                .filter(([key, value]) => key.includes(`id=${nurseId}`))
                .map(([key, value]) => value);
              // Ensure functionality is triggered for initial load
              triggerFunctionalityNurse();
            },
            error: function (xhr, status, error) {
              // Handle errors
              console.error(error);
            },
          });
        }

        // Function to trigger functionality on nurse or date change
        function triggerFunctionalityNurse() {
          // Empty the time array
          timeNurse = [];

          // Iterate over the orari data
          orariNurse.forEach((entry) => {
            // Iterate over the keys and values of each entry
            Object.entries(entry).forEach(([date, times]) => {
              // select the date and add the times of that date to the time array
              if (date === getDate) {
                timeNurse.push(...times);
              }
            });
          });

          // Show all options
          for (let i = 0; i < timeSelectNurse.options.length; i++) {
            const option = timeSelectNurse.options[i];
            option.style.display = "block";
          }

          // Iterate in each time value
          for (let i = 0; i < timeNurse.length; i++) {
            const timeValue = timeNurse[i];
            // Iterate in each option
            for (let j = 0; j < timeSelectNurse.options.length; j++) {
              const option = timeSelectNurse.options[j];
              // Check all the options with the array times values
              if (option.value === timeValue) {
                option.style.display = "none";
              }
            }
          }
        }

        // Listen for medico change
        $("#medico").change(function () {
          medicoId = $(this).val();
          document.getElementById("time").selectedIndex = 0;
          fetchOrariData(medicoId);
        });

        // Listen for nurse change
        $("#nurse").change(function () {
          nurseId = $(this).val();
          document.getElementById("time").selectedIndex = 0;
          fetchOrariNurseData(nurseId);
        });

        // Listen for date change
        $("#date").change(function () {
          getDate = $(this).val();
          if (
            $("#visitType").val() === "Prelievi" ||
            $("#visitType").val() === "Medication"
          ) {
            triggerFunctionalityNurse();
          } else {
            triggerFunctionalityMedico();
          }
        });

        // Handle visit type change
        $("#visitType").change(function () {
          const visitType = $(this).val();
          if (visitType === "Prelievi" || visitType === "Medication") {
            $("#medicoContainer").hide();
            $("#nurseContainer").show();

            nurseId = $("#nurse").val();
            if (nurseId) {
              fetchOrariNurseData(nurseId);
            }
          } else {
            $("#medicoContainer").show();
            $("#nurseContainer").hide();
            medicoId = $("#medico").val();
            if (medicoId) {
              fetchOrariData(medicoId);
            }
          }
          getDate = $("#date").val();
          disableTimeOptions();
        });

        // Initial load
        const visitType = $("#visitType").val();
        if (visitType === "Prelievi" || visitType === "Medication") {
          $("#medicoContainer").hide();
          $("#nurseContainer").show();
          nurseId = $("#nurse").val();
          if (nurseId) {
            fetchOrariNurseData(nurseId);
          }
        } else {
          $("#medicoContainer").show();
          $("#nurseContainer").hide();
          medicoId = $("#medico").val();
          if (medicoId) {
            fetchOrariData(medicoId);
          }
        }
        getDate = $("#date").val();
        disableTimeOptions();
      });
    </script>
  </body>
</html>
